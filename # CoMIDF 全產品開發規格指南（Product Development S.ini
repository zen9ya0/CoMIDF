# CoMIDF 全產品開發規格指南（Product Development Specification）【已整合 SaaS 模式、封包分流、進階模組擴充】

> 本指南為 CoMIDF 系列產品（Edge Agent + MSSP Cloud 平台）完整、可落地、可商業化的產品規格，涵蓋：
>
> * 架構設計與功能模組
> * SaaS MSSP 模式與雲端安裝分流
> * 封包監控與回報機制
> * 進階模組功能擴充（DNS/QUIC/gRPC, CTI, Flow, LLM）

---

## 1. 系統總覽

CoMIDF 為一套多協定協作式入侵偵測框架，支援 HTTP(S)、MQTT、CoAP、Modbus、Zigbee、QUIC、DNS、NetFlow 等協定與通訊格式。架構具備以下特性：

* Edge Agent 支援協定封包擷取與即時偵測，資料回報 Cloud 平台；
* Cloud 平台整合分析、AI 融合、策略回饋、自動報表；
* 可支援 MSSP SaaS 模式，跨千個 Edge Agent 管理。

---

## 2. 架構分層

| 層級                | 模組                                     | 功能概要                  | 技術棧                                           |
| ----------------- | -------------------------------------- | --------------------- | --------------------------------------------- |
| Edge Layer        | Protocol Agents, FAL, Secure Connector | 擷取封包、特徵萃取、UER 上傳      | Python / libpcap / gRPC / TLS 1.3             |
| Cloud Layer       | GC, PR, AFL, CTI, LLM                  | 融合分析、策略下發、說明生成、IOC 標記 | FastAPI / Kafka / PostgreSQL / Redis / Docker |
| Integration Layer | SOAR / CTI / XDR 整合                    | 威脅連結分析與自動化應對          | STIX / TAXII / OpenCTI / OTX / XSOAR          |
| Management Layer  | Portal / Tenant / Key Issuer           | SaaS租戶註冊、Agent金鑰發放、監控 | React / Keycloak / Prometheus / Grafana       |

---

## 3. 功能需求更新（包含擴充模組）

### A. 協定與資料來源擴充

* ✅ MQTT, HTTP, CoAP, Modbus, Zigbee（已支援）
* 🆕 DNS：支援封包擷取與 entropy/TTL 分析
* 🆕 QUIC：支援基於 metadata 偵測與連線行為聚合
* 🆕 gRPC：以 HTTP/2 headers 結構統計提取
* 🆕 NetFlow/sFlow：flow-based features 輸入支援

### B. 智慧型分析模組

* ✅ Bayesian + Dempster–Shafer 融合邏輯（GC）
* ✅ Active Feedback Loop（信任值、門檻、自適應學習）
* 🆕 CTI 自動比對（IP / domain 對應 IOC 清單）
* 🆕 LLM 威脅說明引擎（Posterior → 自然語言解釋）

### C. SaaS/MSSP 專用機制

* 🆕 Edge Agent 註冊流程需與 Tenant 管理平台整合
* 🆕 Cloud 自動發放 Agent 專屬 JWT + mTLS 憑證
* 🆕 雲端與 Agent 使用 TCP/443 反向通道（Reverse Proxy）建立通訊

---

## 4. 安裝與部署分流設計（Edge / Cloud 雙網卡模式）

### ✅ Cloud-Platform 安裝腳本必須：

* 自動列出所有網卡（非 lo）
* 讓使用者手動選擇：

  * `mgmt_iface`：UI / API / SSH 管理網卡
  * `data_iface`：資料接收用（Kafka / UER Gateway）
* 生成 `/etc/comidf/cloud_net_config.yaml` 作為配置依據

### ✅ Edge-Agent 安裝腳本必須：

* 自動偵測 interface list
* 讓使用者手動指定：

  * `mgmt_iface`：TLS 通訊與註冊用
  * `sniff_iface`：封包擷取（libpcap）介面
* 儲存為 `/etc/comidf/agent_net_config.yaml`

---

## 5. 雲端 AI 融合與學習強化

* ✅ Trust-based weight 更新：`w_i(t+1) = α w_i(t) + (1-α) acc_i`
* 🆕 Online recalibration：根據誤報率自動調整各 Agent 的門檻值
* 🆕 Semi-supervised clustering：對未知流量做 anomaly 聚類
* 🆕 Federated learning（可選）：租戶間共享權重不共享資料

---

## 6. LLM 威脅說明引擎

### 功能：

* 根據 posterior、流量特徵、協定類型，自動產生自然語言威脅說明。

### 輸入：

```json
{
  "proto": "MQTT",
  "score": 0.88,
  "conf": 0.91,
  "attck_hint": ["T1041"],
  "features": {"len_mean":142, "iat_mean":22}
}
```

### 輸出範例：

> 「來自 10.0.0.5 的 MQTT 流量平均封包大小 142 byte，間隔為 22ms，可能為 T1041 資料外洩通道。模型評分為 0.88，置信度 0.91。」

---

## 7. CTI 整合模組設計

* ✅ 每筆 UER 在 Cloud 端進入 GC 前，先進行 IOC 比對：

  * 比對 src/dst IP, domain, URL against OpenCTI/MISP/OTX feeds
  * 命中後標記：`ioc_hit: true`、`ioc_source`: ["MISP"]、`attck_hint: ["T1568"]`
* ✅ 改變 PR 評分策略，提升警示優先級或強制列入報表

---

## 8. 更新開發時程建議（包含擴充模組）

| 階段      | 模組擴充任務                       | 時程    |
| ------- | ---------------------------- | ----- |
| Phase 2 | 增加 DNS / QUIC / gRPC Agents  | 3 週   |
| Phase 3 | NetFlow/sFlow 模組設計與測試        | 2 週   |
| Phase 4 | CTI Feed 對接與 IOC 比對模組        | 2 週   |
| Phase 5 | LLM 威脅說明引擎接入與回應 API          | 2 週   |
| Phase 6 | Reverse Proxy 通道與 Agent 註冊整合 | 1.5 週 |
| Phase 7 | 雙網卡安裝腳本製作與部署整合測試             | 1 週   |

---

> 本版《CoMIDF 全產品開發規格指南》已整合所有 SaaS、網卡設定、協定擴充、AI 強化與 MSSP 架構升級項目，作為後續 Edge / Cloud 開發與 UI/整合設計的統一標準。
